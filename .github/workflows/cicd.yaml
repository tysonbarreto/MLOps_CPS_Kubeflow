name: ğŸš€ CICD Deployment to GKE

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    name: Build & Deploy to GKE
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§¾ Checkout Repository
      uses: actions/checkout@v3

    - name: ğŸ” Authenticate to Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: ğŸ› ï¸ Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ secrets.GCP_PROJECT_ID }}
        install_components: kubectl

    - name: ğŸ“¦ Configure Docker to use Artifact Registry
      run: |
        gcloud auth configure-docker us-central1-docker.pkg.dev

    - name: ğŸ—ï¸ Build and Push Docker Image
      run: |
        IMAGE_URI=${{ secrets.ARTIFACT_REPO_LINK }}/${{ secrets.DEPLOYMENT_NAME }}:$GITHUB_SHA
        docker build -t $IMAGE_URI .
        docker push $IMAGE_URI

    - name: ğŸ”— Get GKE Credentials
      run: |
        gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} \
          --region ${{ secrets.GKE_REGION }} \
          --project ${{ secrets.GCP_PROJECT_ID }}

    - name: ğŸš¢ Deploy to Kubernetes
      run: |
        kubectl apply -f kubernetes_deployment.yaml
        kubectl set image deployment/${{ secrets.DEPLOYMENT_NAME }} \
          ${{
            secrets.DEPLOYMENT_NAME
          }}=${{ secrets.ARTIFACT_REPO_LINK }}/${{ secrets.DEPLOYMENT_NAME }}:$GITHUB_SHA
        kubectl rollout status deployment/${{ secrets.DEPLOYMENT_NAME }}


