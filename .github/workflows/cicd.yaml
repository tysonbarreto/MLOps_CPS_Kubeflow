name: "CICD Deployment to GKE"

on:
    push:
        branches:
            - main
        
jobs:
    build-and-deploy:
        runs-on: ubuntu-latest
        container:
            image: google/cloud-sdk:496.0.0-stable

        steps:
            - name: Checkout Repository
              uses: actions/checkout@v2

            - name: Authenticating GCloud
              uses: google-github-actions/auth@v1
              with:
                credentials_json: ${{ secrets.GCP_SA_KEY }}
            
            - name: Configure GCloud
              run: |
                gcloud config set project ${{ secrets.GCP_PROJECT_ID }}
                gcloud auth configure-docker us-central1-docker.pkg.dev

            - name: Set up Docker
              uses: docker/setup-docker-action@v4

            - name: Check Docker version
              run: docker --version

            - name: Building and Pushing Image to GCloud Artifact Repo
              run: |
                docker build -t ${{ secrets.ARTIFACT_REPO_LINK }}/${{ secrets.DEPLOYMENT_NAME }}:$GITHUB_SHA .
                docker push ${{ secrets.ARTIFACT_REPO_LINK }}/${{ secrets.DEPLOYMENT_NAME }}:$GITHUB_SHA

            - name: GKE Configurations
              run: |
                gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} --region ${{ secrets.GKE_REGION }} --project ${{ secrets.GCP_PROJECT_ID }}

            - name: Deploying to Kubernetes
              run: |
                kubectl apply -f kubernetes_deployment.yaml
                kubectl set image deployment/${{ secrets.DEPLOYMENT_NAME }}=${{ secrets.ARTIFACT_REPO_LINK }}/${{ secrets.DEPLOYMENT_NAME }}:$GITHUB_SHA
            
# name: üöÄ CICD Deployment to GKE

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-and-deploy:
#     name: Build & Deploy to GKE
#     runs-on: ubuntu-latest

#     steps:
#     - name: üßæ Checkout Repository
#       uses: actions/checkout@v3

#     - name: üîê Authenticate to Google Cloud
#       uses: google-github-actions/auth@v1
#       with:
#         credentials_json: ${{ secrets.GCP_SA_KEY }}

#     - name: üõ†Ô∏è Set up Google Cloud SDK
#       uses: google-github-actions/setup-gcloud@v1
#       with:
#         project_id: ${{ secrets.GCP_PROJECT_ID }}
#         install_components: kubectl

#     - name: üì¶ Configure Docker to use Artifact Registry
#       run: |
#         gcloud auth configure-docker ${{ secrets.ARTIFACT_REPO_LINK }}

#     - name: üèóÔ∏è Build and Push Docker Image
#       run: |
#         IMAGE_URI=${{ secrets.ARTIFACT_REPO_LINK }}/${{ secrets.DEPLOYMENT_NAME }}:$GITHUB_SHA
#         docker build -t $IMAGE_URI .
#         docker push $IMAGE_URI

#     - name: üîó Get GKE Credentials
#       run: |
#         gcloud container clusters get-credentials ${{ secrets.GKE_CLUSTER }} \
#           --region ${{ secrets.GKE_REGION }} \
#           --project ${{ secrets.GCP_PROJECT_ID }}

#     - name: üö¢ Deploy to Kubernetes
#       run: |
#         kubectl apply -f kubernetes_deployment.yaml
#         kubectl set image deployment/${{ secrets.DEPLOYMENT_NAME }} \
#           ${{
#             secrets.DEPLOYMENT_NAME
#           }}=${{ secrets.ARTIFACT_REPO_LINK }}/${{ secrets.DEPLOYMENT_NAME }}:$GITHUB_SHA
#         kubectl rollout status deployment/${{ secrets.DEPLOYMENT_NAME }}


